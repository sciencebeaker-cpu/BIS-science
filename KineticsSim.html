<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collision Theory Simulator - MYP5 Science</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        canvas { border-radius: 12px; }
        .graph-container {
            height: 160px;
            width: 100%;
            position: relative;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const HomeIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        );
        const PlayIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        );
        const ResetIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
        );

        const App = () => {
            const [temp, setTemp] = useState(50);
            const [concentration, setConcentration] = useState(30);
            const [isPowder, setIsPowder] = useState(false);
            const [isRunning, setIsRunning] = useState(false);
            const [dataPoints, setDataPoints] = useState([]);
            const [reactionStats, setReactionStats] = useState({ collisions: 0, successful: 0 });
            
            const canvasRef = useRef(null);
            const particles = useRef([]);
            const requestRef = useRef();
            const timeRef = useRef(0);

            // Simulation Constants
            const WIDTH = 400;
            const HEIGHT = 300;
            const PARTICLE_RADIUS = 5;
            const EA_THRESHOLD = 70; 

            const initParticles = () => {
                const newParticles = [];
                for (let i = 0; i < concentration; i++) {
                    newParticles.push({
                        x: Math.random() * (WIDTH - 20) + 10,
                        y: Math.random() * (HEIGHT - 20) + 10,
                        vx: (Math.random() - 0.5) * (temp / 10),
                        vy: (Math.random() - 0.5) * (temp / 10),
                        type: 'reactant',
                        color: '#3b82f6'
                    });
                }
                
                if (isPowder) {
                    for(let i=0; i<8; i++) {
                        for(let j=0; j<2; j++) {
                            newParticles.push({
                                x: 50 + i * 40, y: 140 + j * 20,
                                vx: 0, vy: 0, type: 'surface', color: '#94a3b8', static: true
                            });
                        }
                    }
                } else {
                    for(let i=0; i<4; i++) {
                        for(let j=0; j<4; j++) {
                            newParticles.push({
                                x: 170 + i * 15, y: 130 + j * 15,
                                vx: 0, vy: 0, type: 'surface', color: '#94a3b8', static: true
                            });
                        }
                    }
                }
                particles.current = newParticles;
                setDataPoints([{x: 0, y: 0}]);
                setReactionStats({ collisions: 0, successful: 0 });
                timeRef.current = 0;
            };

            useEffect(() => {
                initParticles();
            }, [concentration, isPowder, temp]);

            const update = () => {
                if (!isRunning) return;
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, WIDTH, HEIGHT);

                let frameCollisions = 0;
                let frameSuccessful = 0;

                particles.current.forEach((p, i) => {
                    if (!p.static && p.type !== 'product') {
                        p.x += p.vx;
                        p.y += p.vy;

                        // Wall Bouncing
                        if (p.x < 5) { p.x = 5; p.vx *= -1; }
                        if (p.x > WIDTH - 5) { p.x = WIDTH - 5; p.vx *= -1; }
                        if (p.y < 5) { p.y = 5; p.vy *= -1; }
                        if (p.y > HEIGHT - 5) { p.y = HEIGHT - 5; p.vy *= -1; }

                        // Collision Detection
                        particles.current.forEach((p2, j) => {
                            if (i === j || p2.type === 'product') return;
                            
                            const dx = p.x - p2.x;
                            const dy = p.y - p2.y;
                            const dist = Math.sqrt(dx*dx + dy*dy);
                            const minDist = PARTICLE_RADIUS * 2;

                            if (dist < minDist) {
                                // 1. Resolve Overlap immediately to prevent "sticking"
                                const overlap = minDist - dist;
                                const nx = dx / dist; // normal vector x
                                const ny = dy / dist; // normal vector y
                                p.x += nx * overlap;
                                p.y += ny * overlap;

                                if (p2.type === 'surface') {
                                    frameCollisions++;
                                    const energy = (Math.abs(p.vx) + Math.abs(p.vy)) * 15;
                                    
                                    if (energy > EA_THRESHOLD) {
                                        p.type = 'product';
                                        p.color = '#22c55e';
                                        p.vx *= 0.2; 
                                        p.vy *= 0.2;
                                        frameSuccessful++;
                                    } else {
                                        // Standard Reflective Bounce
                                        p.vx *= -1;
                                        p.vy *= -1;
                                    }
                                } else {
                                    // Reactant to Reactant bounce
                                    p.vx *= -1;
                                    p.vy *= -1;
                                }
                            }
                        });
                    }

                    // Draw
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, PARTICLE_RADIUS, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    if (p.type === 'reactant' && (Math.abs(p.vx) + Math.abs(p.vy)) * 15 > EA_THRESHOLD) {
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = p.color;
                    } else {
                        ctx.shadowBlur = 0;
                    }
                    ctx.fill();
                    ctx.closePath();
                });

                if (frameCollisions > 0 || frameSuccessful > 0) {
                    setReactionStats(prev => ({
                        collisions: prev.collisions + frameCollisions,
                        successful: prev.successful + frameSuccessful
                    }));
                }

                timeRef.current += 1;
                if (timeRef.current % 10 === 0) {
                    const productsCount = particles.current.filter(p => p.type === 'product').length;
                    setDataPoints(prev => [...prev, { x: timeRef.current, y: productsCount }]);
                }

                requestRef.current = requestAnimationFrame(update);
            };

            useEffect(() => {
                if (isRunning) {
                    requestRef.current = requestAnimationFrame(update);
                }
                return () => cancelAnimationFrame(requestRef.current);
            }, [isRunning]);

            const handleReset = () => {
                setIsRunning(false);
                initParticles();
            };

            const maxVisibleTime = Math.max(2000, timeRef.current);
            const polylinePoints = dataPoints.map(d => {
                const x = (d.x / maxVisibleTime) * 100;
                const y = 100 - (d.y / concentration) * 100;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center">
                    <div className="w-full max-w-5xl">
                        
                        {/* Header */}
                        <header className="flex flex-col md:flex-row justify-between items-center bg-white p-5 rounded-2xl shadow-sm border border-slate-200 mb-6 gap-4">
                            <div className="flex items-center gap-4">
                                <a href="index.html" className="p-2.5 bg-slate-100 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Back to Hub">
                                    <HomeIcon />
                                </a>
                                <div>
                                    <h1 className="text-xl font-black text-slate-900 leading-none">Collision Theory Simulator</h1>
                                    <p className="text-xs text-slate-500 font-bold uppercase mt-1 tracking-wider">Kinetics & Rate of Reaction</p>
                                </div>
                            </div>
                            <div className="flex gap-3">
                                <button 
                                    onClick={() => setIsRunning(!isRunning)} 
                                    className={`flex items-center gap-2 px-6 py-2 rounded-xl font-bold transition-all shadow-md ${isRunning ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' : 'bg-indigo-600 text-white hover:bg-indigo-700'}`}
                                >
                                    {isRunning ? "Pause" : <React.Fragment><PlayIcon /> Start Reaction</React.Fragment>}
                                </button>
                                <button onClick={handleReset} className="p-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 transition-all shadow-sm">
                                    <ResetIcon />
                                </button>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <div className="lg:col-span-4 space-y-6">
                                <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                                    <h2 className="text-sm font-black text-slate-400 uppercase mb-6 tracking-widest">Variables</h2>
                                    
                                    <div className="mb-8">
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-bold text-slate-700">Temperature</label>
                                            <span className="text-xs font-black text-indigo-600">{temp}°C</span>
                                        </div>
                                        <input type="range" min="10" max="150" value={temp} onChange={(e) => setTemp(Number(e.target.value))} className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                        <p className="text-[10px] text-slate-400 mt-2 italic">Affects particle speed & energy per collision.</p>
                                    </div>

                                    <div className="mb-8">
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-bold text-slate-700">Concentration</label>
                                            <span className="text-xs font-black text-indigo-600">{concentration} mol/dm³</span>
                                        </div>
                                        <input type="range" min="10" max="80" value={concentration} onChange={(e) => setConcentration(Number(e.target.value))} className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                        <p className="text-[10px] text-slate-400 mt-2 italic">Affects the frequency of collisions.</p>
                                    </div>

                                    <div>
                                        <label className="text-sm font-bold text-slate-700 mb-3 block">Surface Area (Solid Reactant)</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button 
                                                onClick={() => setIsPowder(false)}
                                                className={`py-2 rounded-xl text-xs font-bold border-2 transition-all ${!isPowder ? 'bg-indigo-50 border-indigo-600 text-indigo-700' : 'bg-white border-slate-100 text-slate-400'}`}
                                            >
                                                Large Lump
                                            </button>
                                            <button 
                                                onClick={() => setIsPowder(true)}
                                                className={`py-2 rounded-xl text-xs font-bold border-2 transition-all ${isPowder ? 'bg-indigo-50 border-indigo-600 text-indigo-700' : 'bg-white border-slate-100 text-slate-400'}`}
                                            >
                                                Fine Powder
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-slate-900 rounded-3xl p-6 text-white shadow-xl">
                                    <h2 className="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest">Collision Data</h2>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <div className="text-2xl font-black text-white leading-none">{reactionStats.collisions}</div>
                                            <div className="text-[10px] font-bold text-slate-400 uppercase mt-1">Total Collisions</div>
                                        </div>
                                        <div>
                                            <div className="text-2xl font-black text-emerald-400 leading-none">{reactionStats.successful}</div>
                                            <div className="text-[10px] font-bold text-slate-400 uppercase mt-1">Successful</div>
                                        </div>
                                    </div>
                                    <div className="mt-6 pt-4 border-t border-slate-800">
                                        <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">Success Rate</div>
                                        <div className="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-indigo-500 transition-all duration-300" 
                                                style={{ width: `${reactionStats.collisions > 0 ? (reactionStats.successful / reactionStats.collisions * 100) : 0}%` }}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-8 space-y-6">
                                <div className="bg-white p-2 rounded-[2rem] border border-slate-200 shadow-sm relative overflow-hidden">
                                    <canvas 
                                        ref={canvasRef} 
                                        width={WIDTH} 
                                        height={HEIGHT} 
                                        className="w-full bg-slate-50"
                                    />
                                    <div className="absolute top-6 right-6 flex flex-col gap-2">
                                        <div className="flex items-center gap-2 bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-slate-200 text-[10px] font-bold">
                                            <div className="w-2 h-2 rounded-full bg-blue-500"></div> Reactant
                                        </div>
                                        <div className="flex items-center gap-2 bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-slate-200 text-[10px] font-bold">
                                            <div className="w-2 h-2 rounded-full bg-emerald-500"></div> Product
                                        </div>
                                        <div className="flex items-center gap-2 bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-slate-200 text-[10px] font-bold">
                                            <div className="w-2 h-2 rounded-full bg-slate-400"></div> Solid Surface
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                                    <h2 className="text-sm font-black text-slate-800 mb-4">Rate Analysis: Yield vs. Time</h2>
                                    <div className="graph-container">
                                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full overflow-visible">
                                            <line x1="0" y1="0" x2="0" y2="100" stroke="#e2e8f0" strokeWidth="1" />
                                            <line x1="0" y1="100" x2="100" y2="100" stroke="#e2e8f0" strokeWidth="1" />
                                            
                                            {dataPoints.length > 1 && (
                                                <polyline
                                                    fill="none"
                                                    stroke="#4f46e5"
                                                    strokeWidth="2"
                                                    strokeLinejoin="round"
                                                    points={polylinePoints}
                                                />
                                            )}
                                        </svg>
                                        <div className="absolute left-0 bottom-[-20px] text-[10px] font-bold text-slate-400 uppercase tracking-widest">Time ➔</div>
                                        <div className="absolute left-[-40px] top-1/2 -rotate-90 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Amount of Product</div>
                                    </div>
                                    <div className="mt-8 pt-4 border-t border-slate-50 text-[11px] text-slate-400 italic">
                                        Notice the gradient: The rate is fastest at the start and slows down as reactants are used up.
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
